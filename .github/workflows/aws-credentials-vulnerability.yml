name: AWS Credentials Persistence Demo

on:
  workflow_dispatch:

jobs:
  # Demo 1: Same-Job Persistence (The "Leak")
  # This demonstrates that once configured, credentials are available to ALL subsequent steps in the same job.
  demonstrate-persistence:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS Credentials (v1)
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: AKIAIOSFODNN7EXAMPLE
          aws-secret-access-key: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
          aws-region: us-east-1

      - name: Step 2: Access Credentials
        run: |
          echo "=== Step 2: Immediate Access ==="
          if [ -n "$AWS_ACCESS_KEY_ID" ]; then
            echo "✅ Credentials available in Step 2"
            echo "Access Key: ${AWS_ACCESS_KEY_ID:0:10}..."
          else
            echo "❌ Credentials NOT found"
          fi

      - name: Step 3: Access Credentials (Later Step)
        run: |
          echo "=== Step 3: Persistence Check ==="
          if [ -n "$AWS_ACCESS_KEY_ID" ]; then
            echo "✅ Credentials STILL available in Step 3"
            echo "This confirms credentials persist for the entire job duration."
          fi

  # Demo 2: Cross-Job Isolation (The "Fix" by architecture)
  # This demonstrates that a separate job does NOT have access, proving GitHub-hosted runners are isolated.
  demonstrate-isolation:
    runs-on: ubuntu-latest
    needs: demonstrate-persistence
    steps:
      - name: Check for Leaked Credentials
        run: |
          echo "=== Cross-Job Isolation Check ==="
          if [ -n "$AWS_ACCESS_KEY_ID" ]; then
            echo "⚠️  Unexpected: Credentials leaked across jobs!"
          else
            echo "✅ Safe: Credentials did NOT leak to this new job."
            echo "Each job runs on a fresh virtual machine."
          fi
