name: AWS Credentials Vulnerability Demo (v1)

# このワークフローは aws-actions/configure-aws-credentials v1 の脆弱性を示すデモです
# v1では、認証情報が環境変数として後続のjobに漏洩する問題があります

on:
  workflow_dispatch:  # 手動実行のみ
  # push:
  #   branches:
  #     - 'demo/aws-creds-vuln'  # デモ用ブランチでのみ実行（必要に応じてコメント解除）

jobs:
  # Job 1: AWS認証情報を設定するジョブ
  configure-aws:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS Credentials (v1 - VULNERABLE)
        uses: aws-actions/configure-aws-credentials@v1
        with:
          # 注意: これらはダミーの認証情報です。実際のAWSでは使用できません
          aws-access-key-id: AKIAIOSFODNN7EXAMPLE
          aws-secret-access-key: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
          aws-region: us-east-1

      - name: Display AWS credentials (Job 1)
        run: |
          echo "=== Job 1: AWS認証情報の確認 ==="
          echo "AWS_ACCESS_KEY_ID が設定されているか: $(if [ -n "$AWS_ACCESS_KEY_ID" ]; then echo 'YES'; else echo 'NO'; fi)"
          echo "AWS_SECRET_ACCESS_KEY が設定されているか: $(if [ -n "$AWS_SECRET_ACCESS_KEY" ]; then echo 'YES'; else echo 'NO'; fi)"
          echo "AWS_REGION: $AWS_REGION"
          echo ""
          echo "実際の値の一部（マスク前）:"
          echo "AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:0:10}..."
          echo "AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:0:10}..."

      - name: Attempt AWS operation (will fail with dummy credentials)
        continue-on-error: true
        run: |
          echo "AWS CLIコマンドを試行（ダミー認証情報のため失敗します）"
          aws sts get-caller-identity || echo "予想通り、ダミー認証情報では認証に失敗しました"

  # Job 2: 認証情報が漏洩するかを確認するジョブ
  # v1では、Job 1で設定した認証情報がこのジョブでも利用可能になってしまいます
  check-credential-leak:
    runs-on: ubuntu-latest
    needs: configure-aws
    steps:
      - name: Check for leaked credentials (VULNERABILITY)
        run: |
          echo "=== Job 2: 認証情報の漏洩チェック ==="
          echo "このジョブでは AWS 認証情報を設定していません"
          echo ""
          
          if [ -n "$AWS_ACCESS_KEY_ID" ]; then
            echo "⚠️  脆弱性検出: AWS_ACCESS_KEY_ID が漏洩しています!"
            echo "AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID:0:10}..."
          else
            echo "✅ AWS_ACCESS_KEY_ID は漏洩していません"
          fi
          
          if [ -n "$AWS_SECRET_ACCESS_KEY" ]; then
            echo "⚠️  脆弱性検出: AWS_SECRET_ACCESS_KEY が漏洩しています!"
            echo "AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY:0:10}..."
          else
            echo "✅ AWS_SECRET_ACCESS_KEY は漏洩していません"
          fi
          
          if [ -n "$AWS_REGION" ]; then
            echo "⚠️  脆弱性検出: AWS_REGION が漏洩しています!"
            echo "AWS_REGION: $AWS_REGION"
          else
            echo "✅ AWS_REGION は漏洩していません"
          fi

      - name: Display all environment variables
        run: |
          echo "=== 全環境変数の確認 ==="
          echo "AWS関連の環境変数:"
          env | grep -i aws || echo "AWS関連の環境変数は見つかりませんでした"

  # Job 3: 修正版（v2以降）の動作を示すジョブ
  demonstrate-fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure AWS Credentials (v4 - FIXED)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          # 同じダミー認証情報を使用
          aws-access-key-id: AKIAIOSFODNN7EXAMPLE
          aws-secret-access-key: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
          aws-region: us-east-1

      - name: Display AWS credentials (Job 3 - v4)
        run: |
          echo "=== Job 3: v4での認証情報の確認 ==="
          echo "AWS_ACCESS_KEY_ID が設定されているか: $(if [ -n "$AWS_ACCESS_KEY_ID" ]; then echo 'YES'; else echo 'NO'; fi)"
          echo "AWS_SECRET_ACCESS_KEY が設定されているか: $(if [ -n "$AWS_SECRET_ACCESS_KEY" ]; then echo 'YES'; else echo 'NO'; fi)"
          echo "AWS_REGION: $AWS_REGION"

  # Job 4: v4使用後の認証情報漏洩チェック
  verify-fix:
    runs-on: ubuntu-latest
    needs: demonstrate-fix
    steps:
      - name: Verify credentials are not leaked (v4)
        run: |
          echo "=== Job 4: v4使用後の漏洩チェック ==="
          echo "このジョブでは AWS 認証情報を設定していません"
          echo ""
          
          if [ -n "$AWS_ACCESS_KEY_ID" ] || [ -n "$AWS_SECRET_ACCESS_KEY" ]; then
            echo "⚠️  認証情報が漏洩しています（v4でも問題がある可能性）"
          else
            echo "✅ 認証情報は漏洩していません（v4で修正されています）"
          fi
