# AWS Credentials Vulnerability Demo (CVE-2023-33966)

## 概要

このドキュメントは、`aws-actions/configure-aws-credentials` アクションのv1における認証情報漏洩の脆弱性を説明し、再現する方法を示します。

## 脆弱性の詳細

### 問題の説明

`aws-actions/configure-aws-credentials` のv1では、AWS認証情報が環境変数として設定され、**同じワークフロー内の後続のjobにも引き継がれてしまう**という問題がありました。

これにより、以下のようなセキュリティリスクが発生します:

- 🔴 **意図しない認証情報の共有**: 最初のjobでのみ使用するつもりだった認証情報が、後続の全てのjobで利用可能になる
- 🔴 **権限の過剰付与**: 後続のjobが本来必要としない権限を持つことになる
- 🔴 **攻撃面の拡大**: 後続のjobが侵害された場合、AWS認証情報も漏洩する可能性がある

### 影響を受けるバージョン

- ❌ **v1**: 脆弱性あり
- ✅ **v2以降**: 修正済み（認証情報がjob間で共有されない）

### CVE情報

- **CVE ID**: CVE-2023-33966
- **CVSS Score**: Medium
- **公開日**: 2023年

## 再現手順

### 前提条件

- GitHubリポジトリへのアクセス権限
- GitHub Actionsの実行権限

### ステップ1: ワークフローファイルの確認

このリポジトリには、脆弱性を再現するためのワークフローファイルが含まれています:

- [`.github/workflows/aws-credentials-vulnerability.yml`](file:///.github/workflows/aws-credentials-vulnerability.yml)

### ステップ2: ワークフローの実行

#### 方法1: 手動実行（推奨）

1. GitHubリポジトリのページにアクセス
2. **Actions** タブをクリック
3. 左サイドバーから **"AWS Credentials Vulnerability Demo (v1)"** を選択
4. **"Run workflow"** ボタンをクリック
5. ブランチを選択して実行

#### 方法2: ブランチプッシュ（オプション）

ワークフローファイル内のpushトリガーのコメントを解除してから:

```bash
# デモ用ブランチを作成
git checkout -b demo/aws-creds-vuln

# 変更をコミット（何か変更がある場合）
git commit --allow-empty -m "Trigger AWS credentials vulnerability demo"

# プッシュ
git push origin demo/aws-creds-vuln
```

### ステップ3: 結果の確認

ワークフロー実行後、以下のjobのログを確認してください:

#### Job 1: `configure-aws` 
- AWS認証情報が正しく設定されていることを確認
- 環境変数 `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_REGION` が存在

#### Job 2: `check-credential-leak` ⚠️
- **このjobでは認証情報を設定していないにもかかわらず**、Job 1の認証情報が利用可能
- ログに「⚠️ 脆弱性検出」というメッセージが表示される
- これがv1の脆弱性を示している

#### Job 3: `demonstrate-fix`
- v4を使用して認証情報を設定

#### Job 4: `verify-fix` ✅
- v4使用後は認証情報が漏洩しないことを確認
- ログに「✅ 認証情報は漏洩していません」というメッセージが表示される

## 期待される出力例

### Job 2のログ（v1使用時 - 脆弱性あり）

```
=== Job 2: 認証情報の漏洩チェック ===
このジョブでは AWS 認証情報を設定していません

⚠️  脆弱性検出: AWS_ACCESS_KEY_ID が漏洩しています!
AWS_ACCESS_KEY_ID: AKIAIOSFOD...
⚠️  脆弱性検出: AWS_SECRET_ACCESS_KEY が漏洩しています!
AWS_SECRET_ACCESS_KEY: wJalrXUtnF...
⚠️  脆弱性検出: AWS_REGION が漏洩しています!
AWS_REGION: us-east-1
```

### Job 4のログ（v4使用時 - 修正済み）

```
=== Job 4: v4使用後の漏洩チェック ===
このジョブでは AWS 認証情報を設定していません

✅ 認証情報は漏洩していません（v4で修正されています）
```

## 使用している認証情報について

> [!IMPORTANT]
> このデモで使用している認証情報は**ダミー**です。実際のAWSでは使用できません。

```yaml
aws-access-key-id: AKIAIOSFODNN7EXAMPLE
aws-secret-access-key: wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY
```

これらは[AWSの公式ドキュメント](https://docs.aws.amazon.com/general/latest/gr/aws-sec-cred-types.html)に記載されているサンプル認証情報です。

## 緩和策と修正方法

### 推奨される対策

1. **v2以降にアップグレード**（最も推奨）

```yaml
- name: Configure AWS Credentials
  uses: aws-actions/configure-aws-credentials@v4  # v1 → v4
  with:
    aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
    aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    aws-region: us-east-1
```

2. **job間で認証情報を分離**

各jobで個別に認証情報を設定し、必要最小限の権限のみを付与します。

3. **OIDC認証の使用**

より安全なOIDC（OpenID Connect）ベースの認証を使用します:

```yaml
- name: Configure AWS Credentials
  uses: aws-actions/configure-aws-credentials@v4
  with:
    role-to-assume: arn:aws:iam::123456789012:role/GitHubActionsRole
    aws-region: us-east-1
```

## 参考資料

- [GitHub Advisory: GHSA-m9f3-5w8r-xp3q](https://github.com/advisories/GHSA-m9f3-5w8r-xp3q)
- [aws-actions/configure-aws-credentials リリースノート](https://github.com/aws-actions/configure-aws-credentials/releases)
- [AWS Security Best Practices for GitHub Actions](https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services)

## トラブルシューティング

### ワークフローが実行されない

- リポジトリでGitHub Actionsが有効になっているか確認
- ワークフローファイルが `.github/workflows/` ディレクトリに配置されているか確認

### 認証情報が表示されない

- GitHub Actionsは機密情報を自動的にマスクします
- このデモでは、マスクされる前に一部の文字列を表示しています
- ダミー認証情報のため、完全にマスクされない場合があります

### 実際のAWS認証情報でテストしたい場合

> [!CAUTION]
> 実際のAWS認証情報を使用する場合は、以下に注意してください:
> - 必ず権限を最小限に制限したIAMユーザーを使用
> - テスト後は必ず認証情報をローテーション
> - 本番環境の認証情報は絶対に使用しない
